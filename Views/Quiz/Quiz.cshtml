@model Quizadilla.Models.Quiz
@using System.Linq

@{
    var questions = Model.Questions?.ToList() ?? new List<Quizadilla.Models.Question>();
}

<h2>@Model.Title</h2>
<p>@Model.Description</p>

<div id="scoreSummary" class="alert alert-info d-none text-center">
    <div id="scoreText"></div>
    <a asp-action="Discover" asp-controller="Quiz" class="btn btn-primary mt-3">Back to Discover</a>
</div>

<form id="quizForm">
    <div id="progress" class="mb-3 fw-semibold"></div>

    @for (var i = 0; i < questions.Count; i++)
    {
        var q = questions[i];
        var opts = q.Options?.ToList() ?? new List<Quizadilla.Models.Option>();
        var correctList = opts.Where(o => o.IsCorrect).Select(o => o.OptionText ?? string.Empty).ToList();
        var encodedCorrectJson = System.Text.Json.JsonSerializer.Serialize(correctList);
        <div class="q-step card mb-3" style="@(i == 0 ? "display:block;" : "display:none;")" data-correct='@Html.Raw(encodedCorrectJson)'>
            <div class="card-body">
                <h5 class="card-title">Question @(i + 1): @q.QuestionText</h5>

                @for (var j = 0; j < opts.Count; j++)
                {
                    var opt = opts[j];
                    var inputId = $"q{i}-opt{j}";
                    <div class="form-check">
                        <input class="form-check-input"
                               type="radio"
                               name="answers[@i]"
                               value="@opt.OptionText"
                               id="@inputId" />
                        <label class="form-check-label" for="@inputId">@opt.OptionText</label>
                    </div>
                }

                <div class="mt-3">
                    <div class="feedback small fw-semibold mb-2"></div>
                    <button type="button" class="btn btn-primary check">Check answer</button>
                    <button type="button" class="btn btn-outline-secondary next d-none">Next</button>
                    <button type="button" class="btn btn-success finish d-none">Finish</button>
                </div>
            </div>
        </div>
    }
</form>

@section Scripts{
<script>
(function () {
    const steps = Array.from(document.querySelectorAll('.q-step'));
    const progress = document.getElementById('progress');
    const scoreSummary = document.getElementById('scoreSummary');
    const scoreText = document.getElementById('scoreText');
    let i = 0;
    let score = 0;

    function update() {
        steps.forEach((s, idx) => s.style.display = idx === i ? 'block' : 'none');
        progress.textContent = `Question ${i + 1} of ${steps.length}`;
        scoreSummary.classList.add('d-none');
    }

    function getSelectedValue(stepIndex){
        const radio = document.querySelector(`input[name="answers[${stepIndex}]"]:checked`);
        return radio ? radio.value.trim() : null;
    }

    function setInputsDisabled(stepIndex, disabled){
        document.querySelectorAll(`input[name="answers[${stepIndex}]"]`).forEach(el => el.disabled = disabled);
    }

    function showFeedback(stepEl, ok, correctTexts){
        const box = stepEl.querySelector('.feedback');
        box.classList.remove('text-danger','text-success');
        box.classList.add(ok ? 'text-success' : 'text-danger');
        const correctDisplay = correctTexts.length ? correctTexts.join(', ') : '(no correct answer)';
        box.textContent = ok ? 'Correct!' : `Incorrect. Correct answer(s): ${correctDisplay}`;
    }

    function revealControls(stepEl, isLast){
        stepEl.querySelector('.check').classList.add('d-none');
        if (isLast){
            stepEl.querySelector('.finish').classList.remove('d-none');
        } else {
            stepEl.querySelector('.next').classList.remove('d-none');
        }
    }

    function finalScore(){
        const pct = Math.round((score / steps.length) * 100);
        scoreText.textContent = `Your score: ${score} / ${steps.length} (${pct}%)`;
        scoreSummary.classList.remove('d-none');

        document.getElementById('quizForm').style.display = 'none';
        progress.textContent = 'Quiz complete!';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById('quizForm').addEventListener('click', (e) => {
        const step = steps[i];
        const isLast = (i === steps.length - 1);

        if (e.target.classList.contains('check')) {
            const chosen = getSelectedValue(i);
            if (!chosen) { alert('Please select an answer.'); return; }

            // parse correct answers array from data attribute
            let correctArr = [];
            try {
                correctArr = JSON.parse(step.dataset.correct || '[]').map(s => (s || '').toString().trim());
            } catch (err) {
                correctArr = [];
            }

            const ok = correctArr.some(c => c.toLowerCase() === chosen.toLowerCase());
            if (ok) score++;
            showFeedback(step, ok, correctArr);
            setInputsDisabled(i, true);
            revealControls(step, isLast);
        }

        if (e.target.classList.contains('next')) {
            i++;
            update();
        }

        if (e.target.classList.contains('finish')) {
            finalScore();
        }
    });

    update();
})();
</script>
}
